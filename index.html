<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–∞–º–°–æ–±—ñ–®–µ—Ñ | –†–æ–±–æ—Ç–∞ –û–¥–µ—Å–∞</title>
  <style>
    body {font-family: Arial, sans-serif;background:#f5f7fc;margin:0;padding:0;}
    .main-app {max-width:430px;margin:36px auto;padding:0 6px;}
    .logo {width:70px;display:block;margin:28px auto 12px;}
    .login-form, .reg-form {background:#fff;border-radius:14px;padding:20px 12px 18px;box-shadow:0 2px 18px #d7e4f566;margin-bottom:22px;}
    .login-form h2, .reg-form h2 {margin-top:0;font-size:1.17em;}
    .login-form input, .reg-form input {width:100%;padding:10px 9px;margin:8px 0 14px 0;border-radius:10px;border:1px solid #d8e6fc;}
    .login-form button, .reg-form button, .btn-main {background:#2978e6;color:#fff;border:none;font-weight:bold;font-size:1.04em;padding:12px 0;width:100%;border-radius:10px;box-shadow:0 2px 12px #bdd3fd1c;margin:10px 0;}
    .switch {text-align:center;color:#1a71b1;cursor:pointer;text-decoration:underline;margin:12px 0 0;}
    .user-top {display:flex;justify-content:space-between;align-items:center;background:#e3f0ff;border-radius:13px;padding:10px 14px 8px;margin-bottom:13px;}
    .user-top span {font-size:15px;}
    .ads-list {margin-top:13px;}
    .ad-card {background:#fff;border-radius:12px;padding:10px 11px 6px 11px;margin-bottom:10px;box-shadow:0 1px 8px #dbe3f330;}
    .ad-title {font-size:16px;margin-bottom:6px;font-weight:600;}
    .ad-meta {font-size:12px;color:#3167ae;margin-bottom:5px;}
    .ad-actions {display:flex;align-items:center;justify-content:space-between;}
    .ad-likes {font-size:14px;cursor:pointer;color:#2093e7;display:flex;align-items:center;}
    .ad-likes.liked {color:#ffad3d;}
    .ad-likes span {margin-left:3px;}
    .ad-views {font-size:13px;color:#b6cbe8;}
    .ad-btn {padding:6px 16px;background:#2b81f7;color:#fff;border:none;border-radius:12px;cursor:pointer;font-size:13px;font-weight:700;}
    .add-btn-main {background:#2b81f7; color:#fff;border:none; font-weight:700; font-size:1em; padding:12px 18px;border-radius:13px;margin:15px 0;display:block;box-shadow:0 2px 12px #d7e4f540;width:100%;}
    .modal-bg {position:fixed;z-index:10;top:0;left:0;width:100vw;height:100vh;background:#0006;display:flex;align-items:center;justify-content:center;}
    .modal-card {background:#fff;border-radius:14px;box-shadow:0 4px 22px #b1d6fc42;width:320px;padding:22px 18px 12px;text-align:left;}
    .modal-card h2 {font-size:18px;margin:0 0 14px;}
    .modal-field {margin-bottom:14px;}
    .modal-field input, .modal-field textarea {width:100%;font-size:15px;padding:9px 9px;border-radius:8px;border:1px solid #d7e4f5;outline:none;}
    .modal-btns {display:flex;justify-content:flex-end;gap:15px;}
    .modal-btn {padding:10px 21px;font-size:15px;font-weight:700;border-radius:10px;border:none;background:#2186e7;color:#fff;cursor:pointer;}
    .modal-btn.cancel {background:#f0f0f0;color:#205;}
    .hidden {display:none;}
    .msg {padding:11px 9px;margin:7px 0;background:#fff4cc;border-radius:10px;color:#ae820c;text-align:center;}
  </style>
</head>
<body>
  <div class="main-app" id="main-app">
    <img src="https://i.ibb.co/HLc01jWL/22c6c8c1-5106-4955-bec9-7c071a2a41e3.png" class="logo" alt="logo"/>
    <div id="auth-box">
      <form class="login-form" id="login-form">
        <h2>–í—Ö—ñ–¥ —É –°–∞–º–°–æ–±—ñ–®–µ—Ñ</h2>
        <input type="text" id="login-nick" placeholder="–í–∞—à –Ω—ñ–∫" required>
        <button type="submit">–£–≤—ñ–π—Ç–∏</button>
        <div class="switch" id="go-register">–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç—É? –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</div>
      </form>
      <form class="reg-form hidden" id="reg-form">
        <h2>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
        <input type="text" id="reg-nick" placeholder="–ë–∞–∂–∞–Ω–∏–π –Ω—ñ–∫" required>
        <input type="tel" id="reg-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required>
        <button type="submit">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
        <div class="switch" id="go-login">–í–∂–µ —î –∞–∫–∞—É–Ω—Ç? –£–≤—ñ–π—Ç–∏</div>
      </form>
    </div>
    <div id="user-panel" class="hidden">
      <div class="user-top">
        <span id="user-greet"></span>
        <button class="add-btn-main" id="add-btn">–î–æ–¥–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</button>
      </div>
      <div class="ads-list" id="ads-list"></div>
    </div>
  </div>
  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è -->
  <div class="modal-bg hidden" id="add-modal">
    <div class="modal-card">
      <h2>–î–æ–¥–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</h2>
      <form id="add-form">
        <div class="modal-field"><textarea id="task-desc" placeholder="–û–ø–∏—à—ñ—Ç—å –∑–∞–≤–¥–∞–Ω–Ω—è..." required></textarea></div>
        <div class="modal-field"><input type="number" min="0" id="task-price" placeholder="–¶—ñ–Ω–∞, –≥—Ä–Ω" required></div>
        <div class="modal-field"><input type="tel" id="task-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required></div>
        <div class="modal-btns">
          <button type="button" class="modal-btn cancel" id="cancel-modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          <button type="submit" class="modal-btn">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
        </div>
      </form>
    </div>
  </div>
  <div class="msg hidden" id="msg"></div>
  <script>
    // --- –ü—Ä–æ—Å—Ç–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ---
    function $(x) {return document.getElementById(x);}
    function showMsg(txt) { $('msg').textContent = txt; $('msg').classList.remove('hidden'); setTimeout(()=>{$('msg').classList.add('hidden');},2000);}
    let ads = [];
    let user = null;

    // --- –õ–æ–≥–∏–∫–∞ ---
    function saveUser(u){localStorage.setItem('sshef_user',JSON.stringify(u));}
    function loadUser(){let d=localStorage.getItem('sshef_user');return d?JSON.parse(d):null;}
    function showPanel(){
      $('auth-box').classList.add('hidden');
      $('user-panel').classList.remove('hidden');
      $('user-greet').textContent = 'üë§ '+user.nick+' | '+user.phone;
      loadAds();
    }
    function showAuth(){
      $('auth-box').classList.remove('hidden');
      $('user-panel').classList.add('hidden');
    }

    // --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º ---
    $('go-register').onclick = ()=>{ $('login-form').classList.add('hidden'); $('reg-form').classList.remove('hidden'); };
    $('go-login').onclick = ()=>{ $('reg-form').classList.add('hidden'); $('login-form').classList.remove('hidden'); };

    // --- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ---
    $('reg-form').onsubmit = async function(e){
      e.preventDefault();
      let nick = $('reg-nick').value.trim();
      let phone = $('reg-phone').value.trim();
      if (!nick || !phone) return showMsg('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è!');
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∫–∞
      let resp = await fetch('http://localhost:8097/check_nick', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nick})});
      let data = await resp.json();
      if (!data.ok) return showMsg('–¢–∞–∫–∏–π –Ω—ñ–∫ –≤–∂–µ —ñ—Å–Ω—É—î!');
      user = {nick, phone};
      saveUser(user);
      $('reg-form').reset();
      showPanel();
      await fetch('http://localhost:8097/visit', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(user)});
    };
    // --- –í—Ö–æ–¥ ---
    $('login-form').onsubmit = async function(e){
      e.preventDefault();
      let nick = $('login-nick').value.trim();
      if (!nick) return showMsg('–í–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫!');
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –Ω–∏–∫–∞
      let resp = await fetch('http://localhost:8097/check_nick', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nick,check_exist:true})});
      let data = await resp.json();
      if (!data.ok) return showMsg('–¢–∞–∫–æ–≥–æ –Ω—ñ–∫—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
      // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –Ω–æ–º–µ—Ä
      user = {nick, phone:data.phone||""};
      saveUser(user);
      showPanel();
    };
    // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ ---
    window.onload = function(){
      user = loadUser();
      if (user) showPanel(); else showAuth();
    };

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π ---
    async function loadAds(){
      let resp = await fetch('http://localhost:8097/ads');
      let data = await resp.json();
      ads = data;
      renderAds();
    }
    // --- –†–µ–Ω–¥–µ—Ä ---
    function renderAds(){
      let wrap = $('ads-list');
      wrap.innerHTML = '';
      if(!ads.length) wrap.innerHTML='<div style="text-align:center;color:#8a8c9b;">–û–≥–æ–ª–æ—à–µ–Ω—å —â–µ –Ω–µ–º–∞—î...</div>';
      ads.forEach(ad=>{
        let adHTML = `<div class="ad-card">
          <div class="ad-title">${ad.desc}</div>
          <div class="ad-meta">üí∞ <b>${ad.price}</b> –≥—Ä–Ω | ${ad.phone} | ${ad.user}</div>
          <div class="ad-actions">
            <div><span class="ad-likes">‚ù§Ô∏è <span>${ad.likes}</span></span>
            <span class="ad-views">üëÅÔ∏è ${ad.views||1}</span></div>
          </div>
        </div>`;
        wrap.innerHTML += adHTML;
      });
    }

    // --- –î–æ–±–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ ---
    $('add-btn').onclick = ()=>{ $('add-modal').classList.remove('hidden'); };
    $('cancel-modal').onclick = ()=>{ $('add-modal').classList.add('hidden'); $('add-form').reset();};
    $('add-form').onsubmit = async function(e){
      e.preventDefault();
      let desc=$('task-desc').value,price=$('task-price').value,phone=$('task-phone').value;
      if(!desc||!price||!phone)return showMsg('–í—Å—ñ –ø–æ–ª—è –æ–±–æ–≤ º—è–∑–∫–æ–≤—ñ!');
      let payload = {desc, price, phone, user:user.nick};
      let resp = await fetch('http://localhost:8097/new_ad', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      $('add-modal').classList.add('hidden');$('add-form').reset();
      if ((await resp.json()).ok) showMsg('–ù–∞ –º–æ–¥–µ—Ä–∞—Ü—ñ—ó!');
      else showMsg('–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞!');
    };
  </script>
</body>
</html>
